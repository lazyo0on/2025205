<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3학년 2반의 추억</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Dalgona/neodgm/neodgm.css">
    <style>
        /* ... (이전 스타일과 동일) ... */
        :root { --pixel-bg: #87CEEB; --pixel-ground: #90EE90; }
        body { margin: 0; overflow: hidden; font-family: 'NeoDunggeunmo', sans-serif; background-color: var(--pixel-bg); user-select: none; }
        canvas { image-rendering: pixelated; display: block; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .pixel-box { background: white; border: 4px solid black; padding: 2rem; text-align: center; pointer-events: auto; box-shadow: 8px 8px 0px rgba(0,0,0,0.2); }
        h1 { font-size: 2.5rem; margin-bottom: 1rem; color: #333; }
        .pixel-btn { background: #ff5e5e; color: white; border: 4px solid black; padding: 15px 30px; font-size: 1.2rem; cursor: pointer; font-family: inherit; }
        .bubble { position: absolute; background: white; border: 2px solid black; padding: 8px 12px; border-radius: 8px; font-size: 14px; pointer-events: none; display: none; z-index: 10; max-width: 200px; white-space: pre-wrap; }
        .bubble::after { content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); border-width: 6px 6px 0; border-style: solid; border-color: black transparent transparent transparent; }
        #game-ui { position: absolute; top: 20px; right: 20px; display: none; gap: 10px; pointer-events: auto; }
        .game-btn { background: #fff; border: 3px solid black; padding: 10px 15px; font-family: inherit; cursor: pointer; }
        #modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 100; pointer-events: auto; }
        .modal-content { background: #fff; border: 4px solid black; padding: 30px; width: 80%; max-width: 500px; max-height: 80vh; overflow-y: auto; position: relative; }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; color: #ff5e5e; }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="game-ui">
        <button class="game-btn" onclick="openDiary()">✨ 학급 일기장</button>
    </div>

    <div id="ui-layer">
        <div class="pixel-box" id="login-box">
            <h1>우리반 추억 보관함</h1>
            <p style="margin-bottom: 20px; font-size: 1.2rem;">비밀번호를 입력하세요</p>
            <input type="password" id="password" style="display:block; width: 100%; padding: 10px; margin-bottom: 20px; font-family: inherit; border: 2px solid black; outline: none;" placeholder="****">
            <button class="pixel-btn" onclick="startGame()">입장하기</button>
            <p id="error-msg" style="color: red; margin-top: 10px; display: none;">암호가 틀렸습니다!</p>
            <p id="loading-msg" style="color: blue; margin-top: 10px; display: none;">이미지 로딩 중...</p>
        </div>
    </div>

    <div id="bubble" class="bubble">안녕!</div>

    <div id="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">X</span>
            <h2 style="margin-top:0; border-bottom: 2px solid #eee; padding-bottom: 10px;">✨ 오늘의 기록</h2>
            <div id="modal-text" style="line-height: 1.8; margin-top: 20px; white-space: pre-wrap;"></div>
        </div>
    </div>

    <script>
        // =================================================================
        // [설정 구역] 
        // =================================================================
        const CONFIG = {
            PASSWORD: "1234",
            
            // 이미지 폴더 이름 (마지막에 / 꼭 붙이기)
            IMAGE_FOLDER: "images/",
            
            // 이미지 파일 이름 목록 (순서대로 적으세요)
            // 예: 1.png, 2.png, 3.png가 있다면 아래처럼 적습니다.
            IMAGE_FILES: ["1.png", "2.png"], 

            TALKS: ["선생님, 안녕하세요!", "오늘 급식 맛있었어요!", "숙제 다 했어요!", "운동장 넓다~", "사랑해요 쌤!"],
            DIARY_ENTRIES: ["아이들의 웃음소리가 가득한 하루였습니다.", "오늘도 우리 반은 평화롭습니다."]
        };
        // =================================================================

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const uiLayer = document.getElementById('ui-layer');
        const loginBox = document.getElementById('login-box');
        const bubble = document.getElementById('bubble');
        const gameUI = document.getElementById('game-ui');
        const modalOverlay = document.getElementById('modal-overlay');
        const modalText = document.getElementById('modal-text');
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const STUDENT_COUNT = 32;
        const PIXEL_SCALE = 4; // 캐릭터 크기 배율 (숫자가 클수록 캐릭터가 커짐)

        // --- 이미지 미리 불러오기 (프리로딩) ---
        const loadedImages = [];
        let imagesLoadedCount = 0;
        let isAllImagesLoaded = false;

        function preloadImages() {
            CONFIG.IMAGE_FILES.forEach((filename, index) => {
                const img = new Image();
                img.src = CONFIG.IMAGE_FOLDER + filename;
                img.onload = () => {
                    imagesLoadedCount++;
                    if (imagesLoadedCount === CONFIG.IMAGE_FILES.length) {
                        isAllImagesLoaded = true;
                        document.getElementById('loading-msg').innerText = "로딩 완료! 입장하세요.";
                        drawBackground();
                    }
                };
                img.onerror = () => {
                    console.error("이미지를 찾을 수 없습니다: " + filename);
                };
                loadedImages.push(img);
            });
        }
        
        // 페이지 열리자마자 이미지 로드 시작
        preloadImages();

        let isPlaying = false;

        class Student {
            constructor(id) {
                this.id = id;
                
                // 첫 번째 이미지를 기준으로 크기 설정 (모든 이미지가 같은 크기여야 함)
                // 로딩이 아직 안 됐을 수 있으므로 기본값 설정 후, draw에서 보정
                this.width = 0; 
                this.height = 0;

                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.speedX = (Math.random() - 0.5) * 2;
                this.speedY = (Math.random() - 0.5) * 2;
                
                // 애니메이션 상태
                this.frameIndex = 0; // 현재 보여줄 이미지 번호
                this.frameCount = 0;
                this.animationSpeed = Math.floor(Math.random() * 5) + 10; // 속도 랜덤
                this.facingRight = this.speedX > 0;

                this.targetX = null;
            }

            update() {
                // 이미지 크기 초기화 (로딩 완료 후 최초 1회)
                if (this.width === 0 && loadedImages[0].width > 0) {
                    this.width = loadedImages[0].width * PIXEL_SCALE;
                    this.height = loadedImages[0].height * PIXEL_SCALE;
                    // 화면 밖으로 나갔다면 위치 보정
                    if (this.x > canvas.width - this.width) this.x = canvas.width - this.width;
                    if (this.y > canvas.height - this.height) this.y = canvas.height - this.height;
                }

                if (this.targetX !== null) {
                    const dx = this.targetX - this.x;
                    const dy = this.targetY - this.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    
                    if (dist > 5) {
                        this.x += (dx / dist) * 3;
                        this.y += (dy / dist) * 3;
                        this.facingRight = dx > 0;
                    } else {
                        this.targetX = null;
                        this.speedX = (Math.random() - 0.5) * 2;
                        this.speedY = (Math.random() - 0.5) * 2;
                    }
                } else {
                    this.x += this.speedX;
                    this.y += this.speedY;

                    if (this.x < 0) { this.x = 0; this.speedX *= -1; this.facingRight = true; }
                    if (this.x > canvas.width - this.width) { this.x = canvas.width - this.width; this.speedX *= -1; this.facingRight = false; }
                    if (this.y < 0) { this.y = 0; this.speedY *= -1; }
                    if (this.y > canvas.height - this.height) { this.y = canvas.height - this.height; this.speedY *= -1; }

                    if (Math.random() < 0.005) {
                        this.speedX = (Math.random() - 0.5) * 2;
                        this.speedY = (Math.random() - 0.5) * 2;
                        if (this.speedX !== 0) this.facingRight = this.speedX > 0;
                    }
                }

                // 프레임 변경 (애니메이션)
                this.frameCount++;
                if (this.frameCount >= this.animationSpeed) {
                    // 다음 이미지로 넘어감 (0 -> 1 -> 2 -> 3 -> 0 ...)
                    this.frameIndex = (this.frameIndex + 1) % loadedImages.length;
                    this.frameCount = 0;
                }
            }

            draw() {
                if (!isAllImagesLoaded) return;

                const currentImage = loadedImages[this.frameIndex];
                
                ctx.save();
                
                // 좌우 반전 처리
                if (!this.facingRight) {
                    ctx.translate(this.x + this.width / 2, this.y + this.height / 2);
                    ctx.scale(-1, 1);
                    ctx.translate(-(this.x + this.width / 2), -(this.y + this.height / 2));
                }

                // 이미지 그리기
                ctx.drawImage(currentImage, this.x, this.y, this.width, this.height);
                
                ctx.restore();

                // 그림자
                ctx.fillStyle = 'rgba(0,0,0,0.2)';
                ctx.fillRect(this.x + (this.width * 0.2), this.y + this.height - 5, this.width * 0.6, 5);
            }
            
            isClicked(mx, my) {
                return mx >= this.x && mx <= this.x + this.width &&
                       my >= this.y && my <= this.y + this.height;
            }
        }

        const students = [];
        for (let i = 0; i < STUDENT_COUNT; i++) {
            students.push(new Student(i + 1));
        }

        function drawBackground() {
            ctx.fillStyle = '#87CEEB';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            const groundY = canvas.height * 0.4;
            ctx.fillStyle = '#90EE90';
            ctx.fillRect(0, groundY, canvas.width, canvas.height - groundY);
            
            // 학교 건물 (간단화)
            const buildingW = 300;
            const buildingH = 200;
            const bx = (canvas.width - buildingW) / 2;
            const by = groundY - buildingH;
            ctx.fillStyle = '#ffddaa'; ctx.fillRect(bx, by, buildingW, buildingH);
            ctx.fillStyle = '#d35400'; ctx.beginPath(); ctx.moveTo(bx - 20, by); ctx.lineTo(bx + buildingW/2, by - 60); ctx.lineTo(bx + buildingW + 20, by); ctx.fill();
        }

        function animate() {
            if (!isPlaying) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBackground();
            students.sort((a, b) => a.y - b.y);
            students.forEach(student => { student.update(); student.draw(); });
            requestAnimationFrame(animate);
        }

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if(isPlaying) requestAnimationFrame(animate);
        });

        canvas.addEventListener('mousedown', (e) => {
            if (!isPlaying) return;
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            let clickedStudent = null;
            for (let i = students.length - 1; i >= 0; i--) {
                if (students[i].isClicked(mouseX, mouseY)) {
                    clickedStudent = students[i];
                    break;
                }
            }
            
            if (clickedStudent) {
                const randomTalk = CONFIG.TALKS[Math.floor(Math.random() * CONFIG.TALKS.length)];
                showBubble(mouseX, mouseY, randomTalk);
            } else {
                showBubble(mouseX, mouseY, "얘들아 모여라!");
                students.forEach(s => {
                    s.targetX = mouseX + (Math.random() - 0.5) * 100;
                    s.targetY = mouseY + (Math.random() - 0.5) * 100;
                });
            }
        });

        function showBubble(x, y, text) {
            bubble.style.left = x + 'px';
            bubble.style.top = (y - 50) + 'px';
            bubble.innerText = text;
            bubble.style.display = 'block';
            clearTimeout(window.bubbleTimer);
            window.bubbleTimer = setTimeout(() => { bubble.style.display = 'none'; }, 3000);
        }

        function startGame() {
            if (!isAllImagesLoaded) {
                document.getElementById('loading-msg').style.display = 'block';
                return;
            }
            const pw = document.getElementById('password').value;
            if (pw === CONFIG.PASSWORD) {
                loginBox.style.display = 'none';
                uiLayer.style.pointerEvents = 'none';
                gameUI.style.display = 'flex';
                isPlaying = true;
                animate();
            } else {
                document.getElementById('error-msg').style.display = 'block';
            }
        }

        function openDiary() {
            modalOverlay.style.display = 'flex';
            const randomEntry = CONFIG.DIARY_ENTRIES[Math.floor(Math.random() * CONFIG.DIARY_ENTRIES.length)];
            modalText.innerText = randomEntry;
        }

        function closeModal() { modalOverlay.style.display = 'none'; }
        modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });
        
        drawBackground();
    </script>
</body>
</html>
